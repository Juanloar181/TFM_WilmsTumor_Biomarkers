---
title: "Mutation Studio"
author: "Author Name"
date: "`r Sys.Date()`"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r}
library(readr)
library(dplyr)
library(Biostrings)
library(stringr)
library(biomaRt)


#Cargar datos
mutations <- read_tsv("data_mutations.txt")

clinical_sample <- read_tsv("data_clinical_sample.txt", comment="#")

mutations_con_paciente <- mutations %>%
  left_join(clinical_sample, by = c("Tumor_Sample_Barcode" = "SAMPLE_ID"))

missense_muts <- mutations_con_paciente %>%
  filter(Variant_Classification == "Missense_Mutation")

#Asignar ID numérico a pacientes
pacientes_id <- missense_muts %>%
  distinct(Tumor_Sample_Barcode) %>%
  mutate(num_paciente = row_number())

#Unir ID numérico a mutaciones
missense_muts <- left_join(missense_muts, pacientes_id, by = "Tumor_Sample_Barcode")

#Guardamos tabla de correspondencia pacientes
write_tsv(pacientes_id, "tabla_pacientes.txt")

#Función extraer péptido 17aa centrado en mutación proteica
extraer_peptido_proteina <- function(protein_seq, pos_aa, window=8) {
  start <- max(1, pos_aa - window)
  end <- min(length(protein_seq), pos_aa + window)
  AAString(subseq(protein_seq, start, end))
}

#Listas separadas para péptidos WT y mutados
lista_peptidos_wt <- AAStringSet()
lista_nombres_wt <- c()
lista_peptidos_mut <- AAStringSet()
lista_nombres_mut <- c()

#Lista para guardar errores
errores <- data.frame(ID_mutacion=integer(), Gen=character(), Paciente=integer(), Mensaje=character(), stringsAsFactors=FALSE)

#Conexión a Ensembl
ensembl <- useEnsembl(biomart = "genes",
                      dataset = "hsapiens_gene_ensembl",
                      host = "www.ensembl.org")

# Obtenemos las secuencias de todos los genes únicos
genes_unicos <- unique(missense_muts$Hugo_Symbol)

seqs_genes <- getSequence(
  id = genes_unicos,
  type = "hgnc_symbol",
  seqType = "peptide",
  mart = ensembl
)

#Bucle que recorre todas las mutaciones
for (i in 1:nrow(missense_muts)) {
  mut <- missense_muts[i, ]
  
  #Extraer info mutación
  hgvsp <- mut$HGVSp_Short
  res <- str_match(hgvsp, "p\\.([A-Z])(\\d+)([A-Z])")
 
  #Manejar error parseo HGVSp_Short 
  if (is.na(res[1,1])) {
    errores <- rbind(errores, data.frame(
      ID_mutacion = i,
      Gen = mut$Hugo_Symbol,
      Paciente = mut$num_paciente,
      Mensaje = paste("No se pudo parsear HGVSp_Short:", hgvsp)
    ))
    next
  }
  
  #Extraer datos mutación
  ref_aa <- res[1,2]
  pos_aa <- as.integer(res[1,3])
  mut_aa <- res[1,4]
  
#Manejar isoformas del gen
isoformas <- seqs_genes %>% filter(hgnc_symbol == mut$Hugo_Symbol)
if (nrow(isoformas) == 0) {
  errores <- rbind(errores, data.frame(
    ID_mutacion = i,
    Gen = mut$Hugo_Symbol,
    Paciente = mut$num_paciente,
    Mensaje = "No se encontró isoforma proteica para el gen"
  ))
  next
}
  
  #Calcular longitud de cada isoforma
  longitudes <- sapply(isoformas$peptide, nchar)
  
  #Escoger secuencia proteína más larga
  pos_max <- which.max(longitudes)
  seq_proteina_larga <- isoformas$peptide[pos_max]
  
  # Crear objeto AAString
  prot_seq <- AAString(seq_proteina_larga)
  
  #Manejamos error isoformas
  if (is.na(seq_proteina_larga) || seq_proteina_larga == "") {
  errores <- rbind(errores, data.frame(
    ID_mutacion = i, Gen = mut$Hugo_Symbol, Paciente = mut$num_paciente,
    Mensaje = "Secuencia proteica vacía o NA"
  ))
  next
  }
  
  #Validar posición aminoácido
  if (pos_aa > length(prot_seq)) {
    errores <- rbind(errores, data.frame(
      ID_mutacion = i,
      Gen = mut$Hugo_Symbol,
      Paciente = mut$num_paciente,
      Mensaje = paste("Posición aminoácido fuera de rango:", pos_aa)
    ))
    next
  }
  
  #Validar aminoácido de referencia
  if (as.character(prot_seq[pos_aa]) != ref_aa) {
    errores <- rbind(errores, data.frame(
      ID_mutacion = i,
      Gen = mut$Hugo_Symbol,
      Paciente = mut$num_paciente,
      Mensaje = paste("Aminoácido referencia no coincide: esperado", ref_aa,
                      "en posición", pos_aa)
    ))
    next
  }
  
  #Crear proteína mutada
  mut_protein <- prot_seq
  mut_protein[pos_aa] <- mut_aa
  
  #Extraer péptidos 17 aa centrados en la mutación
  pep_wt <- extraer_peptido_proteina(prot_seq, pos_aa, window=8)
  pep_mut <- extraer_peptido_proteina(mut_protein, pos_aa, window=8)
  
  #Crear nombres para fasta
nombre <- paste0(mut$num_paciente, "_", mut$Hugo_Symbol, "_", hgvsp)
  
  #Agregar a listas separadas
lista_peptidos_wt <- c(lista_peptidos_wt, AAStringSet(pep_wt))
lista_nombres_wt <- c(lista_nombres_wt, nombre)

lista_peptidos_mut <- c(lista_peptidos_mut, AAStringSet(pep_mut))
lista_nombres_mut <- c(lista_nombres_mut, nombre)
}

#Asignamos nombres
names(lista_peptidos_wt) <- lista_nombres_wt
names(lista_peptidos_mut) <- lista_nombres_mut

# Guardar fasta con péptidos neoantigénicos
#El formato del fasta es Gen+nº paciente+mutación+tipo(wt o mut)
writeXStringSet(lista_peptidos_wt, "peptidos_wt.fasta")
writeXStringSet(lista_peptidos_mut, "peptidos_mutados.fasta")

#Guardamos errores en fichero para ello
if (nrow(errores) > 0) {
  write.csv(errores, "errores_aa.csv", row.names = FALSE)
}
